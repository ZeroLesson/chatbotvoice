<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    {% load static %}
    <link rel="stylesheet" href="{% static 'chat.css' %}">
    <script>
        // ฟังก์ชันเพื่อแสดง alert ถ้ามีข้อความใน messages
        window.onload = function() {
            {% if messages %}
                {% for message in messages %}
                    alert("{{ message }}");
                {% endfor %}
            {% endif %}
        };
    </script>
</head>

<body>

    <div class="chat-container">
        <!-- Chat List -->

        <div class="chat-list">
            {% comment %} <button class="conver"><i class="bi bi-plus-circle"></i></button> {% endcomment %}
            <div class="arrow-container" id="toggleButton">
                <span class="arrow">&#9654;</span> <!-- ลูกศรที่ใช้ -->
                <span class="title">Click to Add New Conversation</span>
            </div>
            <ul id="toggleList" class="hidden-list">
                {%for i in user%}
                <li class="listn" data-id="{{ i.id }}">{{i.username}}</li>
                {%endfor%}
            </ul>
            {% if data %}
            {%for i in data%}
            {% if i.user_2.id == user_id %}
            <div class="chat-item" data-name="{{ i.user_1.username }}" data-conid="{{i.conversationId}}"
                data-ids="{{user_id}}" data-idr="{{i.user_1.id}}" data-last-message="How are you doing?">
                <img src="https://via.placeholder.com/40" alt="Avatar">
                <div class="chat-text">
                    <strong>{{ i.user_1.username }}</strong><br>
                    <span>**********</span>
                </div>
                <span class="time" data-timestamp="{{i.lastest_timestamp}}"></span>
            </div>
            {%else%}
            <div class="chat-item" data-name="{{ i.user_2.username }}" data-conid="{{i.conversationId}}"
                data-ids="{{user_id}}" data-idr="{{i.user_2.id}}" data-last-message="How are you doing?">
                <img src="https://via.placeholder.com/40" alt="Avatar">
                <div class="chat-text">
                    <strong>{{ i.user_2.username }}</strong><br>
                    <!-- <span>**********</span> -->
                </div>
                <span class="time" data-timestamp="{{i.lastest_timestamp}}"></span>
            </div>
            {%endif%}

            {%endfor%}
            {% else %}
            <p>No conversations found.</p>
            {% endif %}
        </div>

        <!-- Chat Window -->
        <div class="chat-window">
            <!-- Chat Header -->
            <div class="chat-header">
                <div><strong id="chatName">Select a Chat</strong></div>
                <div>
                    <button class="logout" onclick="logout()">Logout <i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message sent">
                </div>
            </div>

            <!-- Chat Footer -->
            <div class="chat-footer">
                <audio id="audioPlayback" controls></audio>
                <button id="micButton"><i class="bi bi-mic"></i></button>
            </div>
        </div>
    </div>

    <style>
        #audioPlayback {
            flex-grow: 1;
            display: none;
            width: 100%;
            max-width: none;
        }

        .chat-footer {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            align-items: center;
            background-color: #f5edf5;
            justify-content: center;
            /* จัดให้อยู่ตรงกลาง */
        }

        #micButton {
            font-size: 3.5rem;
            /* ขนาดไอคอนใหญ่ขึ้น */
            background-color: transparent;
            /* พื้นหลังโปร่งใส */
            border: none;
            /* ลบเส้นขอบ */
            outline: none;
            /* ลบขอบที่แสดงเมื่อคลิก */
            cursor: pointer;
            /* เปลี่ยนเคอร์เซอร์เมื่อ hover */
        }

        #micButton i {
            color: #5a5a5a;
            /* เปลี่ยนสีไอคอนไมค์ */
            transition: color 0.3s;
            /* เพิ่ม transition ให้ไอคอน */
        }

        #micButton i:hover {
            color: #ff0000;
            /* สีไอคอนเมื่อ hover */
        }

        .chat-messages {
            height: 400px;
            /* กำหนดความสูงตามต้องการ */
            overflow-y: auto;
            /* ทำให้เลื่อนได้เมื่อมีข้อความมากเกินไป */
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }

        /* Sent messages (aligning the username and message to the left) */
        .chat-message.sent {
            text-align: left;
            justify-content: flex-end;
        }

        /* Received messages (aligning the username and message to the right) */
        .chat-message.received {
            text-align: right;
            justify-content: flex-start;
        }

        /* Username for sent messages (aligned to the left) */
        .username-left {
            display: block;
            font-weight: bold;
            text-align: right;
            /* Make sure the name is on the left */
            margin-bottom: 5px;
        }

        /* Username for received messages (aligned to the right) */
        .username-right {
            display: block;
            font-weight: bold;
            text-align: left;
            /* Make sure the name is on the right */
            margin-bottom: 5px;
        }
    </style>

    <script>
        // JavaScript to handle click event on chat items
        document.querySelectorAll('.chat-item').forEach(item => {
            item.addEventListener('click', async function () {
                const chatName = this.getAttribute('data-name');
                const conid = this.getAttribute('data-conid');
                const ids = this.getAttribute('data-ids');  // user ID of the current session user
                const idr = this.getAttribute('data-idr');
        
                // Update the chat header name
                document.getElementById('chatName').innerText = chatName;
        
                // Clear existing messages before fetching new data
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';  // Clear previous messages
        
                try {
                    // Send a request to the API to get the chat data
                    const response = await fetch('/test/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'  // CSRF token for security
                        },
                        body: JSON.stringify({ 'con_id': conid, 'id_1': ids, 'id_2': idr })
                    });
        
                    // Check if the response is successful
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error fetching chat data:', errorData);
                        alert('Session Token หมดอายุ!!');
                        window.location.href = '';
                        return;  // Exit the function if there's an error
                    }
        
                    const data = await response.json();
        
                    // Sort the messages by timestamp (if needed)
                    data.apidata.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
                    // Function to get the username from the user data by matching the sender_id
                    const findUsername = (senderId) => {
                        const user = data.userdata.find(user => user.id === senderId);
                        return user ? user.username : 'Unknown';  // Default to 'Unknown' if no match found
                    };
        
                    // Loop through data.apidata and create elements for each message
                    for (const message of data.apidata) {
                        // Main container for each message
                        const messageContainerDiv = document.createElement('div');
                        messageContainerDiv.classList.add('message-container');
        
                        // Div for the username
                        const usernameDiv = document.createElement('div');
        
                        // Div for the message content (audio)
                        const messageDiv = document.createElement('div');
        
                        // Check if the message was sent by the current user (session user)
                        if (message.sender_id === ids) {
                            messageDiv.classList.add('chat-message', 'sent');  // Sent message (align left)
                            usernameDiv.classList.add('username-left');  // Align username to the left
                        } else {
                            messageDiv.classList.add('chat-message', 'received');  // Received message (align right)
                            usernameDiv.classList.add('username-right');  // Align username to the right
                        }
        
                        // Get the username of the sender
                        const username = findUsername(message.sender_id);
        
                        // Create a strong element for the username
                        const usernameElement = document.createElement('strong');
                        usernameElement.textContent = username;  // Set the sender's username
                        usernameDiv.appendChild(usernameElement);  // Add the username to the div
        
                        const encodedVoicePath = encodeURIComponent(message.voice_path);
        
                        // Fetch audio data for the message
                        const audioResponse = await fetch('/getaudio/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ 'voice_path': encodedVoicePath })
                        });
        
                        if (!audioResponse.ok) {
                            console.error('Error fetching audio data:', await audioResponse.json());
                            continue;  // Skip to the next message if there's an error
                        }
        
                        const blob = await audioResponse.blob();
        
                        // Create a URL object for the decoded audio file
                        const audioUrl = URL.createObjectURL(blob);
                        const audioElement = document.createElement('audio');
                        audioElement.controls = true;
                        audioElement.src = audioUrl;
                        audioElement.controlsList = "nodownload";
                        audioElement.preload = "none";
        
                        // Add the audio element to the message div
                        messageDiv.appendChild(audioElement);
        
                        // Add the username and message divs to the container
                        messageContainerDiv.appendChild(usernameDiv);
                        messageContainerDiv.appendChild(messageDiv);
        
                        // Append the message container to the chatMessages
                        chatMessages.appendChild(messageContainerDiv);
                    }
        
                    scrollToBottom();  // Scroll to the bottom after appending all messages
        
                } catch (error) {
                    console.error('Unexpected error:', error);
                }
            });
        });

        let mediaRecorder; // ย้าย mediaRecorder มาข้างนอก
        let audioChunks = []; // ย้าย audioChunks มาข้างนอก

        document.getElementById('micButton').addEventListener('click', async function () {
            const audioElement = document.getElementById('audioPlayback');

            if (audioElement.style.display === 'none' || audioElement.style.display === '') {
                audioElement.style.display = 'block'; // แสดง <audio>

                // ใช้ await เพื่อรอการขอสิทธิ์เข้าถึงไมโครโฟน
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    audioChunks = [];
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById("audioPlayback").src = audioUrl;

                    // ส่งไฟล์เสียงไปยัง Django backend
                    const formData = new FormData();
                    const now = new Date();
                    const formatDateForFileName = (date) => {
                        return date.toISOString().replace(/:/g, '-');
                    }

                    // สร้างชื่อไฟล์
                    const fileName = `${formatDateForFileName(now)}.wav`;

                    // เพิ่มข้อมูลอื่น ๆ ลงใน formData
                    formData.append('audio', audioBlob, fileName);

                    fetch('/upload-audio/', {
                        method: 'POST',
                        body: formData,
                    }).then(response => {
                        if (response.ok) {
                            console.log('Audio uploaded successfully!');
                            setTimeout(() => {
                                location.reload();  // ลองทดสอบคำสั่ง location.reload() แยกต่างหาก
                            }, 0);
                        } else {
                            console.error('Error uploading audio');
                        }
                    });

                };

                mediaRecorder.start();
            } else {
                mediaRecorder.stop(); // ใช้ mediaRecorder ที่ถูกกำหนดไว้ข้างนอก
                audioElement.style.display = 'none'; // ซ่อน <audio>
            }
        });

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
    <script>
        function logout() {
            // Redirect ไปยัง URL สำหรับ logout
            window.location.href = "{% url 'logout' %}";
        }

        const toggleButton = document.getElementById('toggleButton');
        const toggleList = document.getElementById('toggleList');
        const arrow = document.querySelector('.arrow');

        // กำหนดการคลิกสำหรับการแสดงหรือซ่อนรายการ
        toggleButton.onclick = function () {
            if (toggleList.style.display === "none" || toggleList.style.display === "") {
                toggleList.style.display = "block"; // แสดงรายการ
                arrow.classList.add('down'); // หมุนลูกศรลง
            } else {
                toggleList.style.display = "none"; // ซ่อนรายการ
                arrow.classList.remove('down'); // หมุนลูกศรกลับ
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const listItems = document.querySelectorAll('.listn');

            // เพิ่ม event listener ให้กับทุก <li>
            listItems.forEach(function (item) {
                item.addEventListener('click', function () {
                    const userId = this.getAttribute('data-id');  // ดึงค่า id จาก data-id attribute
                    // ส่ง request ไปยังฟังก์ชัน add_conversation
                    fetch('/add_conversation/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'  // ส่ง CSRF token เพื่อความปลอดภัย
                        },
                        body: JSON.stringify({ 'user_id': userId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            // แสดงผลลัพธ์หรือทำการเปลี่ยนแปลงหลังจากเรียกใช้ add_conversation
                            console.log('Conversation added', data);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                });
            });
        });
        // ฟังก์ชันคำนวณเวลาที่ผ่านไป
        function timeAgo(timestamp) {
            const timeNow = new Date(); // เวลาปัจจุบันของระบบ

            // แปลง timestamp ให้อยู่ในรูปแบบ UTC
            const dateParts = timestamp.split(/[T:.Z]/);
            const days = dateParts[0].split("-"); // แยกวันที่และเวลา
            const year = parseInt(days[0]);
            const month = parseInt(days[1]) - 1; // เดือนเริ่มจาก 0
            const day = parseInt(days[2]);
            const hours = parseInt(dateParts[1] - 7);
            const minutes = parseInt(dateParts[2]);
            const seconds = parseInt(dateParts[3]);

            const timePast = new Date(Date.UTC(year, month, day, hours, minutes, seconds));
            // คำนวณเวลาในวินาทีที่ผ่านไป
            const secondsAgo = Math.floor((timeNow.getTime() - timePast.getTime()) / 1000);

            if (secondsAgo < 60) return secondsAgo + (secondsAgo === 1 ? " second ago" : " seconds ago");

            let interval = Math.floor(secondsAgo / 60); // นาที
            if (interval < 60) return interval + (interval === 1 ? " minute ago" : " minutes ago");

            interval = Math.floor(interval / 60); // ชั่วโมง
            if (interval < 24) return interval + (interval === 1 ? " hour ago" : " hours ago");

            interval = Math.floor(interval / 24); // วัน
            if (interval < 30) return interval + (interval === 1 ? " day ago" : " days ago");

            interval = Math.floor(interval / 30); // เดือน
            if (interval < 12) return interval + (interval === 1 ? " month ago" : " months ago");

            interval = Math.floor(interval / 12); // ปี
            return interval + (interval === 1 ? " year ago" : " years ago");
        }

        // ใช้ฟังก์ชันนี้กับทุก element ที่มี class 'time'
        document.querySelectorAll('.time').forEach(function (element) {
            const timestamp = element.getAttribute('data-timestamp');
            element.innerText = timeAgo(timestamp);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
        </script>

</body>

</html>